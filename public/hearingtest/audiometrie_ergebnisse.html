<!DOCTYPE html>
<html lang="de">

<head>
    <title>SonaMedic - Audiometrie Ergebnisse</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" rel="stylesheet" />
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/sin_ergebnisse.css" rel="stylesheet" />
    <link href="../css/stylehome.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js für Diagramme -->
    <style>
        .card-header1 {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            background-color: #866a67;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            margin-top: -20px;
            width: 104%; /* Setze die Breite auf 104% */
            max-width: 104%; /* Verhindert, dass sie größer wird */
            min-width: 104%; /* Setzt eine Mindestbreite */
            overflow: hidden; /* Verhindert das Überlaufen des Inhalts */
        }

        .card-header.bg-primary.text-white {
            background-color: #866a67 !important; 
            color: white !important;
            margin-top:10px;
        }

        .card {
            margin-top: 50px;
            margin-left: 10px;
            margin-right: 10px;
        }

        .card.results-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center; /* Inhalte mittig ausrichten */
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background-color: #fefefe;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-left: 150px;
            margin-right: 50px;
            margin-top: -10px;
        }
    
        .chart-container {
            width: 90%; /* Begrenze die Breite */
            max-width: 800px;
            margin: 0 auto;
            margin-left: 10px;
            margin-right: 10px;
            padding: 20px;
        }

        #testList {
            width: 100%;
            max-width: 800px;
            margin: -10 auto;
            margin-left: 10px;
            margin-right: 10px;
            list-style: none;
            padding: 0;
        }

        #testList .result-card {
            margin-bottom: 10px;
            margin-left: 10px;
            margin-right: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            background-color: #f8f8f8;
            text-align: center;
        }

        #testList .result-card strong {
            font-size: 16px;
            color: #333;
            margin-left: 10px;
            margin-right: 10px;
        }

        #testList .result-card .toggle-details {
            display: block;
            margin-top: 10px;
            margin-right: 10px;
            margin-left: 10px;
            color: #866a67;
            cursor: pointer;
        }

        #testList .details-section {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-left: 10px;
            margin-right: 10px;
        }

        #testList .details-section.active {
            display: block;
        }

        #testList .test-detail {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            text-align: left;
        }

        #testList .test-detail p {
            margin: 5px 0;
            font-size: 14px;
        }

    </style>
    
</head>

<body>
    <!-- Navbar Start -->
    <div class="container-fluid sticky-top bg-white shadow-sm">
        <div class="container">
            <nav class="navbar navbar-expand-lg bg-white navbar-light py-3 py-lg-0">
                <a href="../home.html" class="navbar-brand">
                    <img src="../img/logo.jpeg" class="logo-img" width="280">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto py-0">
                        <a href="../home.html" class="nav-item nav-link active">Home</a>
                        <a href="../aboutus.html" class="nav-item nav-link">About Us</a>
                        <a href="../faq.html" class="nav-item nav-link">FAQ</a>
                        <a href="../login.html" class="nav-item nav-link">Login</a>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Linke Navbar Start -->
    <nav class="navbar left-navbar">
        <div class="container">
            <div class="navbar-nav">
                <a href="../notification.html" class="nav-item nav-link">
                    <i class="fas fa-bell"></i> Nachrichten
                    <span id="notificationBadge" class="badge bg-danger ms-2 badge-animation" style="display: none;"></span>
                </a>
                <a href="../stammdaten.html" class="nav-item nav-link">
                    <i class="bi bi-person-badge"></i> Stammdaten
                </a>
                <a href="overview.html" class="nav-item nav-link">
                    <i class="fas fa-headset"></i> Hörtests
                </a>
                <a href="ergebnisse.html" class="nav-item nav-link">
                    <i class="fas fa-chart-line"></i> Ergebnisse
                </a>
                <a href="../booking.html" class="nav-item nav-link">
                    <i class="bi bi-calendar-plus"></i> Buchung
                </a>
                <a href="../booking-overview.html" class="nav-item nav-link">
                    <i class="bi bi-calendar-check"></i> Übersicht
                </a>
                <a href="../information.html" class="nav-item nav-link">
                    <i class="fas fa-info-circle"></i> Informationen
                </a>
            </div>
        </div>
    </nav>
    <!-- Linke Navbar End -->

    <div class="container">
        <h2 class="text-center mb-4">Reintonaudiometrie-Test Ergebnisse</h2>

        <div class="row">
            <!-- Ergebnisse Card -->
            <div class="col-lg-12">
                <div class="card results-card mb-4">
                    <div class="card-header1">Ihre Testergebnisse</div>
                    <!-- Diagramm-Sektion -->
                    <div class="chart-container">
                        <canvas id="resultsChart"></canvas>
                    </div>

                    <!-- Ergebnisse -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">Ihre Tests</div>
                        <div class="card-body">
                            <ul id="testList" class="result-list">
                                <!-- Ergebnisse werden dynamisch geladen -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const testList = document.getElementById('testList');
            const ctx = document.getElementById('resultsChart').getContext('2d');

            let allTests = [];
            let chart;

            // Ergebnisse anzeigen
            function displayResults(tests) {
                testList.innerHTML = '';

                if (tests.length === 0) {
                    testList.innerHTML = '<li class="list-group-item">Keine Testergebnisse verfügbar.</li>';
                } else {
                    // Sortiere die Tests nach Datum und Uhrzeit (neueste zuerst)
                    const sortedTests = tests.sort((a, b) =>
                        new Date(b.rt_datum + ' ' + b.rt_startzeit) - new Date(a.rt_datum + ' ' + a.rt_startzeit)
                    );
                    const groupedTests = groupByTestId(sortedTests);

                    let testCounter = Object.keys(groupedTests).length; // Höchste Nummer für neuesten Test

                    Object.keys(groupedTests).forEach(testId => {
                        const testGroup = groupedTests[testId];
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item result-card';

                        // Hole Startzeit und Endzeit
                        const endzeit = new Date(testGroup[0].rt_endzeit);
                        const startzeit = new Date(testGroup[testGroup.length - 1].rt_startzeit);

                        listItem.innerHTML = `
                            <strong>Test ${testCounter}:</strong> ${new Date(testGroup[0].rt_datum).toLocaleDateString()} <br>
                            <strong>Startzeit:</strong> ${startzeit.toLocaleTimeString()}<br>
                            <strong>Endzeit:</strong> ${endzeit.toLocaleTimeString()}<br>
                            <span class="toggle-details" onclick="toggleDetails('${testId}')">Details anzeigen</span>
                            <div id="details-${testId}" class="details-section">
                                ${testGroup.map(test => `
                                    <div class="test-detail">
                                        <p><strong>Frequenz:</strong> ${test.rt_frequenz} Hz</p>
                                        <p><strong>Ohr:</strong> ${test.rt_ohr}</p>
                                        <p><strong>Lautstärke:</strong> ${test.rt_lautstaerke_db} dB</p>
                                        <p><strong>Gehört:</strong> ${test.rt_gehoert ? 'Ja' : 'Nein'}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        testList.appendChild(listItem);
                        testCounter--; // Nächster Test bekommt die nächstniedrigere Nummer
                    });
                }
            }

            // Funktion zum Gruppieren der Tests nach Test-ID
            function groupByTestId(tests) {
                return tests.reduce((acc, test) => {
                    if (!acc[test.rt_test_id]) {
                        acc[test.rt_test_id] = [];
                    }
                    acc[test.rt_test_id].push(test);
                    return acc;
                }, {});
            }

            // Funktion zum Ein- und Ausblenden der Details
            window.toggleDetails = function (testId) {
                const detailsSection = document.getElementById(`details-${testId}`);
                detailsSection.classList.toggle('active');
            };

            // Diagramm aktualisieren
            function updateChart(tests) {
                if (chart) {
                    chart.destroy(); // Altes Diagramm löschen
                }

                const frequencies = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000, 10000, 12000, 14000];
                const groupedTests = groupByTestId(tests);

                let testCounter = Object.keys(groupedTests).length; // Höchste Nummer für neuesten Test

                const datasets = Object.keys(groupedTests).map(testId => {
                    const testGroup = groupedTests[testId];
                    const data = frequencies.map(freq => {
                        const test = testGroup.find(t => t.rt_frequenz === freq);
                        return test ? (test.rt_gehoert ? 1 : 0) : null;
                    });

                    const dataset = {
                        label: `Test ${testCounter}`, // Korrekte Nummerierung im Diagramm
                        data: data,
                        borderColor: `#${Math.floor(Math.random() * 16777215).toString(16)}`, // Zufällige Farbe
                        fill: false,
                    };

                    testCounter--; // Nächster Test bekommt die nächstniedrigere Nummer
                    return dataset;
                });

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: frequencies,
                        datasets: datasets,
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function (value) {
                                        return value === 1 ? 'Gehört' : 'Nicht gehört';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Ergebnisse vom Server abrufen
            fetch('/getAudiometrieTests') // Hier die URL zu deiner API oder Datenbank einfügen
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Abrufen der Testergebnisse');
                    return response.json();
                })
                .then(tests => {
                    displayResults(tests);
                    updateChart(tests);
                })
                .catch(error => console.error('Fehler:', error));

        });

    </script>
</body>

</html>
